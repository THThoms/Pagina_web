<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CRYPTS OF RUIN</title>
<link href="https://fonts.googleapis.com/css2?family=VT323&family=Courier+Prime:wght@400;700&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #0d0d0d;
  --panel: #111118;
  --border: #2a2a3a;
  --gold: #c8a84b;
  --gold-glow: #c8a84b88;
  --red: #cc3333;
  --green: #44aa44;
  --blue: #4488cc;
  --purple: #9944cc;
  --gray: #666677;
  --white: #e8e8f0;
  --dim: #888899;
  --floor: #1e1e38;
  --wall: #0a0a14;
  --player-col: #f0d060;
  --enemy-col: #cc4444;
  --item-col: #44ccaa;
  --stairs-col: #8888ff;
  --visited: #161625;
}
* { margin:0; padding:0; box-sizing:border-box; }
body {
  background: var(--bg);
  color: var(--white);
  font-family: 'Courier Prime', monospace;
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: flex-start;
  padding: 10px;
  overflow-y: auto;
  overflow-x: hidden;
}
body::before {
  content:'';
  position:fixed; inset:0;
  background: repeating-linear-gradient(0deg, transparent, transparent 3px, rgba(0,0,0,0.08) 3px, rgba(0,0,0,0.08) 4px);
  pointer-events:none; z-index:999;
}
h1.game-title {
  font-family: 'VT323', monospace;
  font-size: clamp(2rem,5vw,3rem);
  color: var(--gold);
  text-shadow: 0 0 20px var(--gold-glow), 0 0 40px rgba(200,168,75,0.3);
  letter-spacing: 8px;
  text-align: center;
  margin-bottom: 6px;
}
.tagline {
  font-size: 0.65rem;
  color: var(--gray);
  letter-spacing: 4px;
  text-align: center;
  margin-bottom: 12px;
}

/* LAYOUT */
.game-wrap {
  display: grid;
  grid-template-columns: 180px 1fr 190px;
  grid-template-rows: auto 1fr auto;
  gap: 8px;
  width: 100%;
  max-width: 980px;
}
.panel {
  background: var(--panel);
  border: 1px solid var(--border);
  padding: 10px;
  position: relative;
  min-width: 0;
  overflow: hidden;
}
.panel-title {
  font-family: 'VT323', monospace;
  font-size: 1rem;
  color: var(--gold);
  letter-spacing: 3px;
  border-bottom: 1px solid var(--border);
  padding-bottom: 5px;
  margin-bottom: 8px;
}

/* MAP CANVAS */
#map-panel {
  grid-column: 2;
  grid-row: 1 / 3;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  min-width: 0;
}
#game-canvas {
  image-rendering: pixelated;
  display: block;
  border: 1px solid var(--border);
  width: 100%;
  max-width: 480px;
  height: auto;
}

/* STATS PANEL */
#stats-panel { grid-column: 1; grid-row: 1; }
.stat-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 6px;
  font-size: 0.75rem;
}
.stat-label { color: var(--dim); letter-spacing: 1px; }
.stat-val { color: var(--white); font-weight: 700; }
.bar-wrap { width: 100%; background: #222; height: 8px; border-radius: 2px; margin-bottom: 8px; }
.bar { height: 100%; border-radius: 2px; transition: width 0.3s; }
.hp-bar { background: linear-gradient(90deg, #882222, #cc3333); }
.mp-bar { background: linear-gradient(90deg, #224488, #4488cc); }
.xp-bar { background: linear-gradient(90deg, #886622, #c8a84b); }

/* INVENTORY */
#inv-panel { grid-column: 1; grid-row: 2; }
.inv-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 4px;
}
.inv-slot {
  aspect-ratio: 1;
  border: 1px solid var(--border);
  background: #0a0a16;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.1rem;
  cursor: pointer;
  transition: border-color 0.2s, background 0.2s;
  position: relative;
}
.inv-slot:hover { border-color: var(--gold); background: #1a1a28; }
.inv-slot.equipped { border-color: var(--gold); box-shadow: inset 0 0 6px rgba(200,168,75,0.3); }
.inv-slot .item-count {
  position: absolute;
  bottom: 1px; right: 2px;
  font-size: 0.5rem;
  color: var(--dim);
}

/* LOG */
#log-panel { grid-column: 2; grid-row: 3; }
#log-panel .panel-title { margin-bottom: 4px; }
#combat-log {
  font-size: 0.65rem;
  height: 80px;
  overflow-y: auto;
  line-height: 1.5;
}
#combat-log::-webkit-scrollbar { width: 3px; }
#combat-log::-webkit-scrollbar-thumb { background: var(--border); }
.log-entry { color: var(--dim); }
.log-entry.important { color: var(--white); }
.log-entry.damage { color: var(--red); }
.log-entry.heal { color: var(--green); }
.log-entry.item { color: var(--item-col); }
.log-entry.level { color: var(--gold); font-weight: 700; }
.log-entry.death { color: var(--red); font-weight: 700; }

/* RIGHT PANEL */
#right-panel { grid-column: 3; grid-row: 1 / 3; }
.skill-btn {
  width: 100%;
  background: #0a0a16;
  border: 1px solid var(--border);
  color: var(--white);
  font-family: 'Courier Prime', monospace;
  font-size: 0.7rem;
  padding: 6px 8px;
  cursor: pointer;
  text-align: left;
  margin-bottom: 4px;
  transition: all 0.2s;
  letter-spacing: 1px;
}
.skill-btn:hover:not(:disabled) { border-color: var(--blue); background: #0a1020; }
.skill-btn:disabled { opacity: 0.35; cursor: default; }
.skill-btn .skill-cost { float: right; color: var(--blue); }
.skill-btn.on-cooldown { border-color: #333; color: #555; }

.floor-info {
  font-family: 'VT323', monospace;
  font-size: 1.4rem;
  color: var(--gold);
  margin-bottom: 8px;
  letter-spacing: 2px;
}
.mini-map {
  margin-top: 10px;
  font-family: 'VT323', monospace;
  font-size: 0.55rem;
  line-height: 1;
  color: var(--gray);
  letter-spacing: 1px;
  overflow: hidden;
}

/* KEYS HINT */
.keys-hint {
  grid-column: 3;
  grid-row: 3;
  background: var(--panel);
  border: 1px solid var(--border);
  padding: 8px;
  font-size: 0.6rem;
  color: var(--dim);
  line-height: 2;
}
.key-tag {
  display: inline-block;
  background: #222;
  border: 1px solid #444;
  padding: 0 4px;
  border-radius: 2px;
  color: var(--white);
  font-size: 0.6rem;
}

/* OVERLAY */
.overlay {
  position: fixed; inset:0;
  background: rgba(0,0,0,0.85);
  display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  z-index: 200;
  gap: 16px;
}
.overlay.hidden { display: none; }
.overlay h2 {
  font-family: 'VT323', monospace;
  font-size: 3rem;
  letter-spacing: 6px;
}
.overlay p { font-size: 0.8rem; color: var(--dim); letter-spacing: 2px; max-width: 380px; text-align: center; line-height: 1.8; }
.btn {
  font-family: 'VT323', monospace;
  font-size: 1.3rem;
  letter-spacing: 4px;
  padding: 10px 32px;
  background: transparent;
  border: 1px solid var(--gold);
  color: var(--gold);
  cursor: pointer;
  transition: all 0.2s;
}
.btn:hover { background: rgba(200,168,75,0.1); box-shadow: 0 0 20px rgba(200,168,75,0.3); }
.stat-sheet {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 6px 20px;
  font-size: 0.75rem;
  color: var(--dim);
  margin: 4px 0;
}
.stat-sheet span { color: var(--white); }

/* TOOLTIP */
#tooltip {
  position: fixed;
  background: #111;
  border: 1px solid var(--gold);
  padding: 6px 10px;
  font-size: 0.7rem;
  pointer-events: none;
  z-index: 500;
  display: none;
  max-width: 160px;
  line-height: 1.6;
}
#tooltip .tt-name { color: var(--gold); font-weight:700; display:block; }
#tooltip .tt-type { color: var(--dim); font-size:0.6rem; }
#tooltip .tt-desc { color: var(--white); margin-top:4px; }
#tooltip .tt-stat { color: var(--green); }

/* RESPONSIVE */
@media (max-width: 820px) {
  .game-wrap {
    grid-template-columns: 150px 1fr 160px;
  }
  .stat-row { font-size: 0.65rem; }
  .panel { padding: 6px; }
  .floor-info { font-size: 1.1rem; }
  .skill-btn { font-size: 0.6rem; padding: 4px 5px; }
  #stats-panel .panel-title, #inv-panel .panel-title, #right-panel .panel-title { font-size: 0.85rem; }
}

/* PARTICLE layer */
#particle-canvas {
  position: fixed; inset: 0;
  pointer-events: none;
  z-index: 100;
}
</style>
</head>
<body>
<canvas id="particle-canvas"></canvas>
<h1 class="game-title">CRYPTS OF RUIN</h1>
<div class="tagline">â–¸ UN ROGUELITE DE MAZMORRAS â—‚</div>

<div class="game-wrap">
  <!-- STATS -->
  <div class="panel" id="stats-panel">
    <div class="panel-title">â—ˆ HÃ‰ROE</div>
    <div class="stat-row"><span class="stat-label">CLASE</span><span class="stat-val" id="s-class">Guerrero</span></div>
    <div class="stat-row"><span class="stat-label">NIVEL</span><span class="stat-val" id="s-level">1</span></div>
    <div style="font-size:0.65rem;color:var(--dim);margin-bottom:2px">HP</div>
    <div class="bar-wrap"><div class="bar hp-bar" id="hp-bar" style="width:100%"></div></div>
    <div class="stat-row" style="margin-top:-4px;margin-bottom:8px"><span class="stat-label">â™¥</span><span class="stat-val" id="s-hp">20/20</span></div>
    <div style="font-size:0.65rem;color:var(--dim);margin-bottom:2px">MP</div>
    <div class="bar-wrap"><div class="bar mp-bar" id="mp-bar" style="width:100%"></div></div>
    <div class="stat-row" style="margin-top:-4px;margin-bottom:8px"><span class="stat-label">â—ˆ</span><span class="stat-val" id="s-mp">10/10</span></div>
    <div style="font-size:0.65rem;color:var(--dim);margin-bottom:2px">XP</div>
    <div class="bar-wrap"><div class="bar xp-bar" id="xp-bar" style="width:0%"></div></div>
    <div class="stat-row" style="margin-top:-4px;margin-bottom:10px"><span class="stat-label">âœ¦</span><span class="stat-val" id="s-xp">0/50</span></div>
    <div class="stat-row"><span class="stat-label">ATK</span><span class="stat-val" id="s-atk">5</span></div>
    <div class="stat-row"><span class="stat-label">DEF</span><span class="stat-val" id="s-def">2</span></div>
    <div class="stat-row"><span class="stat-label">SPD</span><span class="stat-val" id="s-spd">5</span></div>
    <div class="stat-row"><span class="stat-label">ORO</span><span class="stat-val" id="s-gold" style="color:var(--gold)">0</span></div>
    <div class="stat-row"><span class="stat-label">KILLS</span><span class="stat-val" id="s-kills">0</span></div>
  </div>

  <!-- MAP -->
  <div class="panel" id="map-panel">
    <canvas id="game-canvas" width="480" height="340"></canvas>
  </div>

  <!-- INVENTORY -->
  <div class="panel" id="inv-panel">
    <div class="panel-title">â—ˆ INVENTARIO</div>
    <div class="inv-grid" id="inv-grid"></div>
    <div style="font-size:0.65rem;color:var(--dim);margin-top:8px;line-height:1.7">
      Clic: usar/equipar<br>
      <span id="equipped-text" style="color:var(--gold)">Sin arma equipada</span>
    </div>
  </div>

  <!-- LOG -->
  <div class="panel" id="log-panel">
    <div class="panel-title">â—ˆ BITÃCORA</div>
    <div id="combat-log"></div>
  </div>

  <!-- RIGHT -->
  <div class="panel" id="right-panel">
    <div class="floor-info">PISO <span id="floor-num">1</span></div>
    <div class="panel-title">â—ˆ HABILIDADES</div>
    <button class="skill-btn" id="sk-attack" onclick="skillAttack()">âš” ATACAR<span class="skill-cost"></span></button>
    <button class="skill-btn" id="sk-heavy" onclick="skillHeavy()">ğŸ’¥ GOLPE PESADO<span class="skill-cost">3MP</span></button>
    <button class="skill-btn" id="sk-heal" onclick="skillHeal()">ğŸ’Š CURAR<span class="skill-cost">4MP</span></button>
    <button class="skill-btn" id="sk-fireball" onclick="skillFireball()">ğŸ”¥ BOLA DE FUEGO<span class="skill-cost">5MP</span></button>
    <button class="skill-btn" id="sk-stun" onclick="skillStun()">âš¡ ATURDIR<span class="skill-cost">3MP</span></button>
    <button class="skill-btn" id="sk-flee" onclick="skillFlee()">ğŸƒ HUIR</button>
    <div class="panel-title" style="margin-top:10px">â—ˆ EXPLORAR</div>
    <button class="skill-btn" onclick="waitTurn()">â³ ESPERAR</button>
    <div class="mini-map" id="mini-map"></div>
  </div>

  <!-- KEYS -->
  <div class="keys-hint">
    <span class="key-tag">W A S D</span> / <span class="key-tag">â†‘â†â†“â†’</span> mover<br>
    <span class="key-tag">E</span> atacar Â· <span class="key-tag">H</span> curar<br>
    <span class="key-tag">F</span> golpe pesado Â· <span class="key-tag">G</span> bola de fuego<br>
    <span class="key-tag">T</span> aturdir Â· <span class="key-tag">SPACE</span> esperar
  </div>
</div>

<!-- OVERLAYS -->
<div class="overlay" id="start-overlay">
  <h2 style="color:var(--gold)">CRYPTS OF RUIN</h2>
  <p>Desciende a las catacumbas, derrota monstruos, recoge tesoros y sobrevive hasta llegar al piso 10. Â¡Muere y empieza de nuevo!</p>
  <div style="display:flex;gap:12px;flex-wrap:wrap;justify-content:center">
    <button class="btn" onclick="startGame('Guerrero')">âš” GUERRERO</button>
    <button class="btn" onclick="startGame('Mago')" style="border-color:var(--blue);color:var(--blue)">ğŸ”® MAGO</button>
    <button class="btn" onclick="startGame('PÃ­caro')" style="border-color:#44aa88;color:#44aa88">ğŸ—¡ PÃCARO</button>
  </div>
</div>

<div class="overlay hidden" id="gameover-overlay">
  <h2 style="color:var(--red)">â˜  HAS MUERTO</h2>
  <div class="stat-sheet" id="go-stats"></div>
  <button class="btn" onclick="resetGame()">REINTENTAR</button>
</div>

<div class="overlay hidden" id="win-overlay">
  <h2 style="color:var(--gold)">âœ¦ VICTORIA âœ¦</h2>
  <p>Â¡Has conquistado las Crypts of Ruin!</p>
  <div class="stat-sheet" id="win-stats"></div>
  <button class="btn" onclick="resetGame()">NUEVA PARTIDA</button>
</div>

<div class="overlay hidden" id="combat-overlay" style="background:rgba(0,0,0,0.7)">
  <div style="background:#111;border:1px solid var(--red);padding:20px;min-width:320px;max-width:440px">
    <div style="font-family:'VT323',monospace;font-size:1.6rem;color:var(--red);letter-spacing:4px;margin-bottom:10px" id="co-title">âš” COMBATE</div>
    <div style="display:flex;justify-content:space-between;margin-bottom:12px">
      <div>
        <div style="font-size:0.7rem;color:var(--dim)">TÃš</div>
        <div style="font-family:'VT323',monospace;font-size:1.5rem;color:var(--gold)" id="co-player-name">Guerrero</div>
        <div class="bar-wrap" style="width:120px"><div class="bar hp-bar" id="co-p-hp-bar" style="width:100%"></div></div>
        <div style="font-size:0.7rem" id="co-p-hp">20/20</div>
        <div class="bar-wrap" style="width:120px"><div class="bar mp-bar" id="co-p-mp-bar" style="width:100%"></div></div>
        <div style="font-size:0.7rem;color:var(--blue)" id="co-p-mp">10/10</div>
      </div>
      <div style="font-family:'VT323',monospace;font-size:3rem;color:var(--red);align-self:center">VS</div>
      <div style="text-align:right">
        <div style="font-size:0.7rem;color:var(--dim)">ENEMIGO</div>
        <div style="font-family:'VT323',monospace;font-size:1.5rem;color:var(--red)" id="co-enemy-name">Rata</div>
        <div class="bar-wrap" style="width:120px;margin-left:auto"><div class="bar hp-bar" id="co-e-hp-bar" style="width:100%"></div></div>
        <div style="font-size:0.7rem;text-align:right" id="co-e-hp">8/8</div>
        <div style="font-size:0.65rem;color:var(--dim);text-align:right;margin-top:4px" id="co-e-status"></div>
      </div>
    </div>
    <div id="co-log" style="height:90px;overflow-y:auto;font-size:0.7rem;color:var(--dim);border-top:1px solid #222;padding-top:8px;line-height:1.8"></div>
    <div style="display:flex;gap:6px;flex-wrap:wrap;margin-top:10px">
      <button class="skill-btn" style="flex:1;min-width:80px" onclick="combatAction('attack')">âš” Atacar</button>
      <button class="skill-btn" style="flex:1;min-width:80px" id="cb-heavy" onclick="combatAction('heavy')">ğŸ’¥ Pesado<small style="color:var(--blue)"> 3MP</small></button>
      <button class="skill-btn" style="flex:1;min-width:80px" id="cb-fireball" onclick="combatAction('fireball')">ğŸ”¥ Fuego<small style="color:var(--blue)"> 5MP</small></button>
      <button class="skill-btn" style="flex:1;min-width:80px" id="cb-stun" onclick="combatAction('stun')">âš¡ Aturdir<small style="color:var(--blue)"> 3MP</small></button>
      <button class="skill-btn" style="flex:1;min-width:80px" id="cb-heal" onclick="combatAction('heal')">ğŸ’Š Curar<small style="color:var(--blue)"> 4MP</small></button>
      <button class="skill-btn" style="flex:1;min-width:80px" id="cb-item" onclick="combatAction('item')">ğŸ§ª PociÃ³n</button>
      <button class="skill-btn" style="flex:1;min-width:80px" onclick="combatAction('flee')">ğŸƒ Huir</button>
    </div>
  </div>
</div>

<div id="tooltip"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CONSTANTS & CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const TILE = 16;
const MAP_W = 30, MAP_H = 21;
const CANVAS_W = MAP_W * TILE, CANVAS_H = MAP_H * TILE;

const T = { WALL:0, FLOOR:1, DOOR:2, STAIRS:3, CHEST:4 };
const DIR = { w:[0,-1], s:[0,1], a:[-1,0], d:[1,0] };

const ITEM_DEFS = [
  {id:'sword',     name:'Espada',       emoji:'âš”', type:'weapon', atk:4,  desc:'DaÃ±o +4'},
  {id:'axe',       name:'Hacha',        emoji:'ğŸª“', type:'weapon', atk:7,  desc:'DaÃ±o +7'},
  {id:'dagger',    name:'Daga',         emoji:'ğŸ—¡', type:'weapon', atk:3, spd:2, desc:'DaÃ±o +3, Vel +2'},
  {id:'staff',     name:'BÃ¡culo',       emoji:'ğŸª„', type:'weapon', atk:2, mp:5, desc:'DaÃ±o +2, MP+5'},
  {id:'shield',    name:'Escudo',       emoji:'ğŸ›¡', type:'armor', def:4, desc:'DEF +4'},
  {id:'armor',     name:'Armadura',     emoji:'ğŸ¥‹', type:'armor', def:6, desc:'DEF +6'},
  {id:'ring',      name:'Anillo MÃ¡gico',emoji:'ğŸ’', type:'armor', mp:8, desc:'MP +8'},
  {id:'potion',    name:'PociÃ³n HP',    emoji:'ğŸ§ª', type:'consumable', hp:20, desc:'Restaura 20 HP', count:1},
  {id:'potion2',   name:'PociÃ³n Grande',emoji:'âš—', type:'consumable', hp:40, desc:'Restaura 40 HP', count:1},
  {id:'mppotion',  name:'PociÃ³n de MP', emoji:'ğŸ”·', type:'consumable', mp:15, desc:'Restaura 15 MP', count:1},
  {id:'bomb',      name:'Bomba',        emoji:'ğŸ’£', type:'consumable', dmg:15, desc:'DaÃ±o 15 al enemigo', count:1},
  {id:'scroll',    name:'Pergamino',    emoji:'ğŸ“œ', type:'consumable', xp:30, desc:'Gana 30 XP', count:1},
];

const ENEMY_DEFS = [
  {id:'rat',    name:'Rata',       emoji:'ğŸ€', hp:8,  atk:3,  def:0, xp:8,  gold:2,  floor:1},
  {id:'slime',  name:'Slime',      emoji:'ğŸŸ¢', hp:12, atk:4,  def:1, xp:12, gold:3,  floor:1},
  {id:'goblin', name:'Goblin',     emoji:'ğŸ‘º', hp:18, atk:6,  def:2, xp:18, gold:5,  floor:2},
  {id:'skeleton',name:'Esqueleto', emoji:'ğŸ’€', hp:22, atk:7,  def:3, xp:22, gold:6,  floor:3},
  {id:'orc',    name:'Orco',       emoji:'ğŸ‘¹', hp:35, atk:9,  def:4, xp:30, gold:10, floor:4},
  {id:'vampire',name:'Vampiro',    emoji:'ğŸ§›', hp:30, atk:11, def:3, xp:35, gold:12, floor:5, regen:2},
  {id:'demon',  name:'Demonio',    emoji:'ğŸ˜ˆ', hp:45, atk:13, def:5, xp:45, gold:15, floor:6},
  {id:'dragon', name:'DragÃ³n',     emoji:'ğŸ‰', hp:80, atk:18, def:8, xp:100,gold:50, floor:8, boss:true},
  {id:'lich',   name:'Lich',       emoji:'ğŸ¦´', hp:60, atk:20, def:6, xp:80, gold:40, floor:9, boss:true},
  {id:'diablo', name:'DIABLO',     emoji:'ğŸ‘¿', hp:120,atk:25, def:10,xp:200,gold:100,floor:10,boss:true},
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  GAME STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let G = {}; // game state
let inCombat = false;
let currentEnemy = null;
let particles = [];

const canvas = document.getElementById('game-canvas');
const ctx = canvas.getContext('2d');
canvas.width = CANVAS_W; canvas.height = CANVAS_H;

const pcv = document.getElementById('particle-canvas');
pcv.width = window.innerWidth; pcv.height = window.innerHeight;
const pctx = pcv.getContext('2d');

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MAP GENERATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function generateMap(floor) {
  const map = [];
  for(let y=0;y<MAP_H;y++) { map[y]=[]; for(let x=0;x<MAP_W;x++) map[y][x]=T.WALL; }

  const rooms = [];
  const NUM_ROOMS = 6 + Math.min(floor, 4);
  for(let i=0;i<60;i++) {
    if(rooms.length >= NUM_ROOMS) break;
    const rw = 4 + Math.floor(Math.random()*5);
    const rh = 3 + Math.floor(Math.random()*4);
    const rx = 1 + Math.floor(Math.random()*(MAP_W-rw-2));
    const ry = 1 + Math.floor(Math.random()*(MAP_H-rh-2));
    let ok = true;
    for(const r of rooms) {
      if(rx<r.x+r.w+1 && rx+rw>r.x-1 && ry<r.y+r.h+1 && ry+rh>r.y-1) { ok=false; break; }
    }
    if(!ok) continue;
    rooms.push({x:rx,y:ry,w:rw,h:rh});
    for(let y=ry;y<ry+rh;y++) for(let x=rx;x<rx+rw;x++) map[y][x]=T.FLOOR;
  }

  // corridors
  for(let i=1;i<rooms.length;i++) {
    const a=rooms[i-1], b=rooms[i];
    const cx1=Math.floor(a.x+a.w/2), cy1=Math.floor(a.y+a.h/2);
    const cx2=Math.floor(b.x+b.w/2), cy2=Math.floor(b.y+b.h/2);
    let x=cx1,y=cy1;
    while(x!==cx2){map[y][x]=T.FLOOR;x+=x<cx2?1:-1;}
    while(y!==cy2){map[y][x]=T.FLOOR;y+=y<cy2?1:-1;}
  }

  // stairs in last room
  const last = rooms[rooms.length-1];
  const sx = Math.floor(last.x+last.w/2), sy = Math.floor(last.y+last.h/2);
  map[sy][sx] = T.STAIRS;

  // chests
  const chestCount = 2 + Math.floor(Math.random()*2);
  for(let i=0;i<chestCount;i++) {
    const r = rooms[1+Math.floor(Math.random()*(rooms.length-1))];
    const cx = r.x+1+Math.floor(Math.random()*(r.w-2));
    const cy = r.y+1+Math.floor(Math.random()*(r.h-2));
    if(map[cy][cx]===T.FLOOR) map[cy][cx]=T.CHEST;
  }

  // player start
  const first = rooms[0];
  const px = Math.floor(first.x+first.w/2), py = Math.floor(first.y+first.h/2);

  // enemies
  const enemies = [];
  const enemyCount = 3 + floor + Math.floor(Math.random()*3);
  const eligible = ENEMY_DEFS.filter(e=>e.floor<=floor && !e.boss);
  const boss = floor >= 5 ? ENEMY_DEFS.filter(e=>e.boss && e.floor<=floor).pop() : null;

  for(let i=0;i<enemyCount;i++) {
    const r = rooms[1+Math.floor(Math.random()*(rooms.length-1))];
    const ex = r.x+1+Math.floor(Math.random()*(r.w-2));
    const ey = r.y+1+Math.floor(Math.random()*(r.h-2));
    if(map[ey][ex]===T.FLOOR) {
      const def = eligible[Math.floor(Math.random()*eligible.length)];
      const scale = 1 + (floor - def.floor) * 0.15;
      enemies.push({
        ...def,
        hp: Math.round(def.hp*scale), maxHp: Math.round(def.hp*scale),
        atk: Math.round(def.atk*scale), def: def.def,
        x:ex, y:ey, alive:true, stunned:false
      });
    }
  }

  if(boss) {
    const r = rooms[rooms.length-2];
    const bx = Math.floor(r.x+r.w/2), by = Math.floor(r.y+r.h/2);
    enemies.push({...boss, hp:boss.hp,maxHp:boss.hp,x:bx,y:by,alive:true,stunned:false});
  }

  return { map, rooms, playerStart:{x:px,y:py}, enemies, visited: new Set() };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  GAME INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function startGame(cls) {
  document.getElementById('start-overlay').classList.add('hidden');
  const classes = {
    'Guerrero': {hp:25,mp:8,atk:6,def:3,spd:5},
    'Mago':     {hp:16,mp:20,atk:4,def:1,spd:4},
    'PÃ­caro':   {hp:20,mp:10,atk:5,def:2,spd:8},
  };
  const base = classes[cls];
  G = {
    cls, level:1, xp:0, xpNext:50, floor:1,
    hp: base.hp, maxHp: base.hp,
    mp: base.mp, maxMp: base.mp,
    atk: base.atk, def: base.def, spd: base.spd,
    gold: 0, kills: 0,
    inventory: [], equippedWeapon: null, equippedArmor: null,
    ...generateMap(1),
    px: 0, py: 0,
    turnCount: 0, stepsSinceRegen: 0,
    stunned: false
  };
  G.px = G.playerStart.x; G.py = G.playerStart.y;
  markVisible();
  document.getElementById('s-class').textContent = cls;
  addLog(`Entras a las catacumbas como ${cls}. Â¡Buena suerte!`, 'important');
  addLog('Llega al piso 10 y derrota al Diablo final.', 'item');
  renderAll();
  initInventoryUI();
  startParticles();
}

function resetGame() {
  document.getElementById('gameover-overlay').classList.add('hidden');
  document.getElementById('win-overlay').classList.add('hidden');
  document.getElementById('start-overlay').classList.remove('hidden');
  document.getElementById('combat-log').innerHTML = '';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  VISIBILITY / FOG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function markVisible() {
  const r = 5;
  for(let dy=-r;dy<=r;dy++) for(let dx=-r;dx<=r;dx++) {
    if(dx*dx+dy*dy<=r*r+2) {
      const k = `${G.px+dx},${G.py+dy}`;
      G.visited.add(k);
    }
  }
}

function isVisible(x,y) {
  const dx=x-G.px, dy=y-G.py;
  return dx*dx+dy*dy<=25;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RENDERING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const COLORS = {
  wall: '#0c0c1c', wallBorder: '#252540',
  floor: '#1e2040', floorVisited: '#151530',
  stairs: '#4444cc', stairsBorder: '#9999ff',
  chest: '#8a6520', chestOpen: '#333',
  player: '#f0d060', enemy: '#cc4444',
  item: '#44ccaa',
};

function renderAll() {
  if(!G.map) return;
  ctx.fillStyle = '#050508';
  ctx.fillRect(0,0,CANVAS_W,CANVAS_H);

  for(let y=0;y<MAP_H;y++) {
    for(let x=0;x<MAP_W;x++) {
      const vis = isVisible(x,y);
      const wasVis = G.visited.has(`${x},${y}`);
      if(!wasVis && !vis) continue;
      const t = G.map[y][x];
      const alpha = vis ? 1 : 0.55;
      ctx.globalAlpha = alpha;
      drawTile(x,y,t);
    }
  }

  // enemies
  for(const e of G.enemies) {
    if(!e.alive) continue;
    if(!isVisible(e.x,e.y)) continue;
    ctx.globalAlpha = 1;
    ctx.font = `${TILE-2}px serif`;
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText(e.emoji, e.x*TILE+TILE/2, e.y*TILE+TILE/2);
    // HP bar
    const hpPct = e.hp/e.maxHp;
    ctx.fillStyle = '#440000';
    ctx.fillRect(e.x*TILE, e.y*TILE-3, TILE, 2);
    ctx.fillStyle = hpPct>0.5?'#44aa44':hpPct>0.25?'#aaaa44':'#cc3333';
    ctx.fillRect(e.x*TILE, e.y*TILE-3, TILE*hpPct, 2);
    if(e.stunned) {
      ctx.font = '8px serif'; ctx.fillText('âš¡', e.x*TILE+TILE-4, e.y*TILE);
    }
  }

  // player
  ctx.globalAlpha = 1;
  ctx.font = `${TILE}px serif`;
  ctx.textAlign = 'center';
  ctx.textBaseline = 'middle';
  ctx.fillText('ğŸ§™', G.px*TILE+TILE/2, G.py*TILE+TILE/2);

  ctx.globalAlpha = 1;
  updateMiniMap();
}

function drawTile(x,y,t) {
  const px=x*TILE, py=y*TILE;
  const vis = isVisible(x,y);
  if(t===T.WALL) {
    ctx.fillStyle = vis ? '#14142a' : '#0c0c1c';
    ctx.fillRect(px,py,TILE,TILE);
    ctx.fillStyle = vis ? '#2e2e55' : '#1a1a30';
    ctx.fillRect(px,py,TILE,1); ctx.fillRect(px,py,1,TILE);
    ctx.fillRect(px,py+TILE-1,TILE,1); ctx.fillRect(px+TILE-1,py,1,TILE);
  } else if(t===T.FLOOR) {
    ctx.fillStyle = vis ? '#1e2248' : '#14163a';
    ctx.fillRect(px,py,TILE,TILE);
    // subtle grid lines for visible tiles
    if(vis) {
      ctx.fillStyle = 'rgba(100,100,180,0.08)';
      ctx.fillRect(px,py,TILE,1);
      ctx.fillRect(px,py,1,TILE);
    }
  } else if(t===T.STAIRS) {
    ctx.fillStyle = '#1e2248';
    ctx.fillRect(px,py,TILE,TILE);
    ctx.fillStyle = '#4444cc';
    ctx.fillRect(px+2,py+2,TILE-4,TILE-4);
    ctx.fillStyle = '#9999ff';
    ctx.fillRect(px+4,py+4,TILE-8,TILE-8);
    ctx.fillStyle='#ffffff';
    ctx.font = '9px serif'; ctx.textAlign='center'; ctx.textBaseline='middle';
    ctx.fillText('â–¼',px+TILE/2,py+TILE/2);
  } else if(t===T.CHEST) {
    ctx.fillStyle = '#1e2248';
    ctx.fillRect(px,py,TILE,TILE);
    ctx.font = `${TILE-2}px serif`;
    ctx.textAlign='center'; ctx.textBaseline='middle';
    ctx.fillText('ğŸ“¦',px+TILE/2,py+TILE/2);
  } else if(t===T.DOOR) {
    ctx.fillStyle = '#2a1a0a';
    ctx.fillRect(px,py,TILE,TILE);
    ctx.font = '9px serif'; ctx.textAlign='center'; ctx.textBaseline='middle';
    ctx.fillText('ğŸšª',px+TILE/2,py+TILE/2);
  }
}

function updateMiniMap() {
  const SCALE = 3;
  let html = '';
  for(let y=0;y<MAP_H;y++) {
    for(let x=0;x<MAP_W;x++) {
      const vis = G.visited.has(`${x},${y}`);
      const t = G.map[y][x];
      let c = '';
      if(!vis) c='Â·';
      else if(t===T.WALL) c='â–ˆ';
      else if(t===T.STAIRS) c='â–¼';
      else if(t===T.CHEST) c='C';
      else c=' ';
      if(x===G.px && y===G.py) c='@';
      html += `<span style="color:${c==='@'?'#f0d060':c==='â–¼'?'#8888ff':c==='C'?'#44ccaa':c==='â–ˆ'?'#2a2a4a':'#333'}">${c}</span>`;
    }
    html += '<br>';
  }
  document.getElementById('mini-map').innerHTML = html;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  HUD UPDATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateHUD() {
  document.getElementById('s-level').textContent = G.level;
  document.getElementById('s-hp').textContent = `${G.hp}/${G.maxHp}`;
  document.getElementById('s-mp').textContent = `${G.mp}/${G.maxMp}`;
  document.getElementById('s-xp').textContent = `${G.xp}/${G.xpNext}`;
  document.getElementById('s-atk').textContent = effectiveAtk();
  document.getElementById('s-def').textContent = effectiveDef();
  document.getElementById('s-spd').textContent = G.spd;
  document.getElementById('s-gold').textContent = G.gold;
  document.getElementById('s-kills').textContent = G.kills;
  document.getElementById('floor-num').textContent = G.floor;
  document.getElementById('hp-bar').style.width = (G.hp/G.maxHp*100)+'%';
  document.getElementById('mp-bar').style.width = (G.mp/G.maxMp*100)+'%';
  document.getElementById('xp-bar').style.width = (G.xp/G.xpNext*100)+'%';

  if(G.equippedWeapon) {
    document.getElementById('equipped-text').textContent = `${G.equippedWeapon.emoji} ${G.equippedWeapon.name}`;
  } else {
    document.getElementById('equipped-text').textContent = 'Sin arma equipada';
  }
}

function effectiveAtk() { return G.atk + (G.equippedWeapon?.atk||0); }
function effectiveDef() { return G.def + (G.equippedArmor?.def||0); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MOVEMENT & EXPLORATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function tryMove(dx,dy) {
  if(inCombat || !G.map) return;
  const nx=G.px+dx, ny=G.py+dy;
  if(nx<0||ny<0||nx>=MAP_W||ny>=MAP_H) return;
  const tile = G.map[ny][nx];
  if(tile===T.WALL) { addLog('Una pared te bloquea el paso.'); return; }

  // Check enemy at position
  const enemy = G.enemies.find(e=>e.alive&&e.x===nx&&e.y===ny);
  if(enemy) { startCombat(enemy); return; }

  G.px=nx; G.py=ny;
  G.stepsSinceRegen++;
  if(G.stepsSinceRegen>=5) { G.stepsSinceRegen=0; regenPassive(); }

  markVisible();

  // tile events
  if(tile===T.STAIRS) {
    addLog(`Desciendes al piso ${G.floor+1}...`, 'important');
    G.floor++;
    if(G.floor>10) { winGame(); return; }
    const newMap = generateMap(G.floor);
    Object.assign(G, newMap);
    G.px=G.playerStart.x; G.py=G.playerStart.y;
    markVisible();
    addLog(`Piso ${G.floor}. La oscuridad es mÃ¡s densa aquÃ­.`);
    if(G.floor===10) addLog('Â¡Sientes la presencia de DIABLO!', 'death');
  } else if(tile===T.CHEST) {
    openChest(nx,ny);
  }

  G.turnCount++;
  enemyTurn(false);
  updateHUD();
  renderAll();
}

function regenPassive() {
  if(G.hp<G.maxHp) { G.hp=Math.min(G.maxHp,G.hp+1); }
  if(G.mp<G.maxMp) { G.mp=Math.min(G.maxMp,G.mp+1); }
}

function openChest(x,y) {
  G.map[y][x] = T.FLOOR;
  const roll = Math.random();
  if(roll < 0.5) {
    // item
    const candidates = ITEM_DEFS.filter(i=>i.type!=='consumable');
    const extra = ITEM_DEFS.filter(i=>i.type==='consumable');
    const pool = roll<0.3 ? candidates : extra;
    const item = {...pool[Math.floor(Math.random()*pool.length)]};
    if(item.count) item.count=1;
    addToInventory(item);
    addLog(`ğŸ“¦ Cofre: encontraste ${item.emoji} ${item.name}!`, 'item');
    spawnParticles(x*TILE+8, y*TILE+8, 10, '#c8a84b');
  } else {
    const amount = (5+Math.floor(Math.random()*10))*G.floor;
    G.gold += amount;
    addLog(`ğŸ“¦ Cofre: ${amount} monedas de oro!`, 'item');
    spawnParticles(x*TILE+8, y*TILE+8, 8, '#f0d060');
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INVENTORY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function addToInventory(item) {
  if(G.inventory.length>=16) { addLog('Inventario lleno! Objeto perdido.'); return; }
  // stack consumables
  if(item.type==='consumable') {
    const existing = G.inventory.find(i=>i.id===item.id);
    if(existing) { existing.count=(existing.count||1)+1; initInventoryUI(); return; }
  }
  G.inventory.push(item);
  initInventoryUI();
}

function initInventoryUI() {
  const grid = document.getElementById('inv-grid');
  grid.innerHTML = '';
  for(let i=0;i<16;i++) {
    const slot = document.createElement('div');
    slot.className='inv-slot';
    const item = G.inventory[i];
    if(item) {
      slot.textContent = item.emoji;
      if(item.count>1) {
        const cnt = document.createElement('div');
        cnt.className='item-count'; cnt.textContent=item.count;
        slot.appendChild(cnt);
      }
      if(G.equippedWeapon===item || G.equippedArmor===item) slot.classList.add('equipped');
      slot.title=item.name;
      slot.addEventListener('click',()=>useItem(i));
      slot.addEventListener('mouseenter',e=>showTooltip(e,item));
      slot.addEventListener('mouseleave',hideTooltip);
    }
    grid.appendChild(slot);
  }
  updateHUD();
}

function useItem(idx) {
  const item = G.inventory[idx];
  if(!item) return;
  if(item.type==='weapon') {
    if(G.equippedWeapon===item) { G.equippedWeapon=null; addLog(`Desequipas ${item.name}.`); }
    else { G.equippedWeapon=item; addLog(`Equipas ${item.emoji} ${item.name}.`, 'item'); }
  } else if(item.type==='armor') {
    if(G.equippedArmor===item) { G.equippedArmor=null; addLog(`Desequipas ${item.name}.`); }
    else { G.equippedArmor=item; addLog(`Equipas ${item.emoji} ${item.name}.`, 'item'); }
  } else if(item.type==='consumable') {
    consumeItem(item, idx);
  }
  initInventoryUI();
}

function consumeItem(item, idx) {
  if(item.hp) { G.hp=Math.min(G.maxHp,G.hp+item.hp); addLog(`ğŸ’Š Usas ${item.name}. +${item.hp} HP`, 'heal'); }
  if(item.mp) { G.mp=Math.min(G.maxMp,G.mp+item.mp); addLog(`ğŸ”· Usas ${item.name}. +${item.mp} MP`, 'heal'); }
  if(item.xp) { G.xp+=item.xp; addLog(`ğŸ“œ Ganas ${item.xp} XP.`, 'item'); checkLevelUp(); }
  if(item.dmg && inCombat && currentEnemy) {
    const dmg = item.dmg;
    currentEnemy.hp -= dmg;
    addLog(`ğŸ’£ Bomba! ${currentEnemy.name} sufre ${dmg} daÃ±os.`, 'damage');
    updateCombatUI();
    if(currentEnemy.hp<=0) { endCombat(true); return; }
  }
  item.count=(item.count||1)-1;
  if(item.count<=0) G.inventory.splice(idx,1);
  initInventoryUI(); updateHUD();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  COMBAT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function startCombat(enemy) {
  inCombat=true; currentEnemy=enemy;
  document.getElementById('combat-overlay').classList.remove('hidden');
  document.getElementById('co-title').textContent=`âš” COMBATE â€” Piso ${G.floor}`;
  document.getElementById('co-player-name').textContent=`${G.cls} Nv.${G.level}`;
  if(enemy.boss) addLog(`Â¡Â¡ JEFE: ${enemy.name} ${enemy.emoji} !!`, 'death');
  else addLog(`âš” Encuentras ${enemy.emoji} ${enemy.name}!`, 'damage');
  document.getElementById('co-log').innerHTML='';
  updateCombatUI();
  checkCombatButtons();
}

function updateCombatUI() {
  if(!currentEnemy) return;
  document.getElementById('co-enemy-name').textContent=`${currentEnemy.emoji} ${currentEnemy.name}`;
  document.getElementById('co-p-hp').textContent=`${G.hp}/${G.maxHp}`;
  document.getElementById('co-p-mp').textContent=`${G.mp}/${G.maxMp}`;
  document.getElementById('co-e-hp').textContent=`${currentEnemy.hp}/${currentEnemy.maxHp}`;
  document.getElementById('co-p-hp-bar').style.width=(G.hp/G.maxHp*100)+'%';
  document.getElementById('co-p-mp-bar').style.width=(G.mp/G.maxMp*100)+'%';
  document.getElementById('co-e-hp-bar').style.width=(Math.max(0,currentEnemy.hp)/currentEnemy.maxHp*100)+'%';
  document.getElementById('co-e-status').textContent=currentEnemy.stunned?'âš¡ ATURDIDO':'';
  checkCombatButtons();
}

function checkCombatButtons() {
  document.getElementById('cb-heavy').disabled = G.mp<3;
  document.getElementById('cb-fireball').disabled = G.mp<5;
  document.getElementById('cb-stun').disabled = G.mp<3;
  document.getElementById('cb-heal').disabled = G.mp<4;
  const hasPotion = G.inventory.some(i=>i.id==='potion'||i.id==='potion2');
  document.getElementById('cb-item').disabled = !hasPotion;
}

function coLog(msg, cls='') {
  const el=document.getElementById('co-log');
  const div=document.createElement('div');
  div.textContent=msg; if(cls) div.style.color=cls;
  el.appendChild(div);
  el.scrollTop=el.scrollHeight;
}

function combatAction(action) {
  if(!inCombat||!currentEnemy) return;
  let playerDmg=0, msg='';

  if(action==='attack') {
    playerDmg = calcDamage(effectiveAtk(), currentEnemy.def);
    msg=`âš” Atacas a ${currentEnemy.name} por ${playerDmg} daÃ±os.`;
    coLog(msg,'#e8e8f0');
  } else if(action==='heavy') {
    if(G.mp<3) return;
    G.mp-=3;
    playerDmg = Math.floor(calcDamage(effectiveAtk(),currentEnemy.def)*1.8);
    msg=`ğŸ’¥ Golpe Pesado! ${currentEnemy.name} sufre ${playerDmg} daÃ±os.`;
    coLog(msg,'#ffaa44');
  } else if(action==='fireball') {
    if(G.mp<5) return;
    G.mp-=5;
    playerDmg = 8 + G.level*3 + Math.floor(Math.random()*8);
    msg=`ğŸ”¥ Bola de Fuego! ${currentEnemy.name} sufre ${playerDmg} daÃ±os mÃ¡gicos.`;
    coLog(msg,'#ff7744');
  } else if(action==='stun') {
    if(G.mp<3) return;
    G.mp-=3;
    currentEnemy.stunned=true;
    playerDmg = Math.floor(calcDamage(effectiveAtk(),currentEnemy.def)*0.5);
    coLog(`âš¡ Aturdiste a ${currentEnemy.name}! Sufre ${playerDmg} daÃ±os y pierde su turno.`,'#8888ff');
  } else if(action==='heal') {
    if(G.mp<4) return;
    G.mp-=4;
    const healAmt = 10+G.level*2+Math.floor(Math.random()*8);
    G.hp=Math.min(G.maxHp,G.hp+healAmt);
    coLog(`ğŸ’Š Te curas ${healAmt} HP.`,'#44aa44');
    updateCombatUI(); updateHUD();
    enemyCombatTurn(); return;
  } else if(action==='item') {
    const potIdx = G.inventory.findIndex(i=>i.id==='potion'||i.id==='potion2');
    if(potIdx>=0) { consumeItem(G.inventory[potIdx], potIdx); updateCombatUI(); enemyCombatTurn(); return; }
    return;
  } else if(action==='flee') {
    const success = Math.random() < (0.3 + G.spd*0.04);
    if(success) {
      coLog('ğŸƒ Â¡Escapas del combate!','#aaaaaa');
      addLog('Huyes del combate.'); endCombat(false); return;
    } else {
      coLog('ğŸƒ Intentas huir... Â¡pero fallas!','#cc6666');
      enemyCombatTurn(); return;
    }
  }

  if(playerDmg>0) currentEnemy.hp-=playerDmg;
  if(currentEnemy.hp<=0) { endCombat(true); return; }
  if(!currentEnemy.stunned) enemyCombatTurn();
  else { currentEnemy.stunned=false; updateCombatUI(); }
  updateHUD();
}

function enemyCombatTurn() {
  if(!currentEnemy||currentEnemy.hp<=0) return;
  // Regen vampiro
  if(currentEnemy.regen) {
    currentEnemy.hp=Math.min(currentEnemy.maxHp,currentEnemy.hp+currentEnemy.regen);
    coLog(`ğŸ§› ${currentEnemy.name} se regenera ${currentEnemy.regen} HP.`,'#884488');
  }
  const dmg = Math.max(1, currentEnemy.atk - effectiveDef() + Math.floor(Math.random()*4)-1);
  G.hp=Math.max(0,G.hp-dmg);
  coLog(`${currentEnemy.emoji} ${currentEnemy.name} te ataca por ${dmg} daÃ±os.`,'#cc4444');
  if(G.hp<=0) { endCombat(false); return; }
  updateCombatUI(); updateHUD();
}

function calcDamage(atk, def) {
  return Math.max(1, atk - def + Math.floor(Math.random()*4));
}

function endCombat(won) {
  document.getElementById('combat-overlay').classList.add('hidden');
  inCombat=false;
  if(won) {
    currentEnemy.alive=false;
    G.kills++;
    G.xp+=currentEnemy.xp; G.gold+=currentEnemy.gold;
    addLog(`âœ“ Derrotas a ${currentEnemy.emoji} ${currentEnemy.name}! +${currentEnemy.xp}xp +${currentEnemy.gold}oro`, 'item');
    spawnParticles(currentEnemy.x*TILE+8, currentEnemy.y*TILE+8, 12, '#cc4444');
    checkLevelUp();
    // random item drop
    if(Math.random()<0.25) {
      const pool = ITEM_DEFS.filter(i=>i.type==='consumable');
      const item = {...pool[Math.floor(Math.random()*pool.length)], count:1};
      addToInventory(item);
      addLog(`ğŸ’ ${currentEnemy.name} dejÃ³ ${item.emoji} ${item.name}!`, 'item');
    }
  } else if(G.hp<=0) {
    gameOver();
    return;
  }
  currentEnemy=null;
  updateHUD(); renderAll();
}

function checkLevelUp() {
  if(G.xp>=G.xpNext) {
    G.level++;
    G.xp-=G.xpNext; G.xpNext=Math.floor(G.xpNext*1.5);
    G.maxHp+=5; G.hp=Math.min(G.maxHp,G.hp+8);
    G.maxMp+=3; G.mp=Math.min(G.maxMp,G.mp+3);
    G.atk+=1; G.def+=1;
    addLog(`âœ¦ NIVEL ${G.level}! HP+5 MP+3 ATK+1 DEF+1`, 'level');
    spawnParticles(G.px*TILE+8, G.py*TILE+8, 20, '#c8a84b');
    updateHUD();
  }
}

// Enemy passive move (when player moves)
function enemyTurn(fromCombat=false) {
  for(const e of G.enemies) {
    if(!e.alive) continue;
    if(!isVisible(e.x,e.y)) continue;
    // move toward player
    const dx=G.px-e.x, dy=G.py-e.y;
    const dist=Math.abs(dx)+Math.abs(dy);
    if(dist<=1) { if(!fromCombat) startCombat(e); return; }
    if(dist>8) continue;
    // simple pathfinding: move in dominant direction
    const mx=dx===0?0:(dx>0?1:-1);
    const my=dy===0?0:(dy>0?1:-1);
    const nx=e.x+mx, ny=e.y+my;
    if(nx>=0&&ny>=0&&nx<MAP_W&&ny<MAP_H && G.map[ny][nx]!==T.WALL) {
      const blocked=G.enemies.some(o=>o.alive&&o!==e&&o.x===nx&&o.y===ny);
      if(!blocked && !(nx===G.px&&ny===G.py)) { e.x=nx; e.y=ny; }
    }
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SKILLS (keyboard shortcuts)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function skillAttack() { if(inCombat) combatAction('attack'); }
function skillHeavy() { if(inCombat) combatAction('heavy'); }
function skillHeal() { if(inCombat) combatAction('heal'); }
function skillFireball() { if(inCombat) combatAction('fireball'); }
function skillStun() { if(inCombat) combatAction('stun'); }
function skillFlee() { if(inCombat) combatAction('flee'); }
function waitTurn() {
  if(inCombat) return;
  regenPassive(); regenPassive();
  addLog('Esperas un turno...');
  enemyTurn(false); updateHUD(); renderAll();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  GAME OVER / WIN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function gameOver() {
  inCombat=false;
  document.getElementById('combat-overlay').classList.add('hidden');
  document.getElementById('gameover-overlay').classList.remove('hidden');
  document.getElementById('go-stats').innerHTML=`
    <div>Nivel</div><div><span>${G.level}</span></div>
    <div>Piso</div><div><span>${G.floor}</span></div>
    <div>Kills</div><div><span>${G.kills}</span></div>
    <div>Oro</div><div><span>${G.gold}</span></div>
    <div>XP</div><div><span>${G.xp}</span></div>
    <div>Turnos</div><div><span>${G.turnCount}</span></div>
  `;
}

function winGame() {
  document.getElementById('win-overlay').classList.remove('hidden');
  document.getElementById('win-stats').innerHTML=`
    <div>Nivel</div><div><span>${G.level}</span></div>
    <div>Kills</div><div><span>${G.kills}</span></div>
    <div>Oro</div><div><span>${G.gold}</span></div>
  `;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  LOG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function addLog(msg, cls='') {
  const log=document.getElementById('combat-log');
  const div=document.createElement('div');
  div.className='log-entry'+(cls?' '+cls:'');
  div.textContent=msg;
  log.appendChild(div);
  if(log.children.length>40) log.removeChild(log.firstChild);
  log.scrollTop=log.scrollHeight;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TOOLTIP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showTooltip(e, item) {
  const tt=document.getElementById('tooltip');
  tt.innerHTML=`<span class="tt-name">${item.emoji} ${item.name}</span>
    <span class="tt-type">${item.type}</span>
    <div class="tt-desc">${item.desc}</div>`;
  tt.style.display='block';
  tt.style.left=(e.pageX+12)+'px'; tt.style.top=(e.pageY-10)+'px';
}
function hideTooltip() { document.getElementById('tooltip').style.display='none'; }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PARTICLES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function spawnParticles(cx,cy,count,color) {
  const rect=canvas.getBoundingClientRect();
  for(let i=0;i<count;i++) {
    const angle=Math.random()*Math.PI*2;
    const spd=1+Math.random()*3;
    particles.push({
      x:rect.left+cx, y:rect.top+cy,
      vx:Math.cos(angle)*spd, vy:Math.sin(angle)*spd,
      life:1, color, size:2+Math.random()*3
    });
  }
}

function startParticles() {
  function tick() {
    pctx.clearRect(0,0,pcv.width,pcv.height);
    particles=particles.filter(p=>{
      p.x+=p.vx; p.y+=p.vy; p.vy+=0.1; p.life-=0.03;
      if(p.life<=0) return false;
      pctx.globalAlpha=p.life;
      pctx.fillStyle=p.color;
      pctx.beginPath();
      pctx.arc(p.x,p.y,p.size,0,Math.PI*2);
      pctx.fill();
      return true;
    });
    pctx.globalAlpha=1;
    requestAnimationFrame(tick);
  }
  tick();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  KEYBOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.addEventListener('keydown', e=>{
  if(!G.map) return;
  if(e.key==='ArrowUp'   ||e.key==='w'||e.key==='W') { e.preventDefault(); tryMove(0,-1); }
  if(e.key==='ArrowDown' ||e.key==='s'||e.key==='S') { e.preventDefault(); tryMove(0,1); }
  if(e.key==='ArrowLeft' ||e.key==='a'||e.key==='A') { e.preventDefault(); tryMove(-1,0); }
  if(e.key==='ArrowRight'||e.key==='d'||e.key==='D') { e.preventDefault(); tryMove(1,0); }
  if(e.key==='e'||e.key==='E') { if(inCombat) combatAction('attack'); }
  if(e.key==='h'||e.key==='H') { if(inCombat) combatAction('heal'); }
  if(e.key==='f'||e.key==='F') { if(inCombat) combatAction('heavy'); }
  if(e.key==='g'||e.key==='G') { if(inCombat) combatAction('fireball'); }
  if(e.key==='t'||e.key==='T') { if(inCombat) combatAction('stun'); }
  if(e.key===' ') { e.preventDefault(); waitTurn(); }
});

// Canvas click to move
canvas.addEventListener('click', e=>{
  if(inCombat) return;
  const rect=canvas.getBoundingClientRect();
  const tx=Math.floor((e.clientX-rect.left)/TILE);
  const ty=Math.floor((e.clientY-rect.top)/TILE);
  const dx=tx-G.px, dy=ty-G.py;
  if(Math.abs(dx)+Math.abs(dy)===1) tryMove(dx,dy);
  else if(Math.abs(dx)<=1&&Math.abs(dy)<=1&&(dx!==0||dy!==0)) tryMove(Math.sign(dx)||0,Math.sign(dy)||0);
});

// Init particles loop before game starts
(function tick() { pctx.clearRect(0,0,pcv.width,pcv.height); requestAnimationFrame(tick); })();
</script>
</body>
</html>
